<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Permessi Sindacali - FP CGIL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        @media print {
            @page { size: landscape; margin: 10mm; }
            body { -webkit-print-color-adjust: exact; background: white; color: black; }
            .no-print { display: none !important; }
            input { border: none !important; background: transparent !important; color: black !important; width: auto !important; }
            table { width: 100% !important; border-collapse: collapse !important; }
            th { border-bottom: 2px solid black !important; padding: 10px 5px !important; }
            td { border-bottom: 1px solid #ddd !important; padding: 12px 5px !important; }
            .bg-red-700, .bg-red-950, .bg-blue-50, .bg-red-50 { background: transparent !important; color: black !important; border: 1px solid #eee !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;

        // Icone SVG Native per massima compatibilità standalone
        const CheckIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        );
        const XIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="text-red-600 animate-pulse"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
        );
        const UserIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        );
        const ShieldIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        );

        const App = () => {
            const [dipendenti, setDipendenti] = useState(100);
            const [enteNome, setEnteNome] = useState("");
            
            const BIG_4_SIGLE = ['FP CGIL', 'CISL FP', 'UIL FPL', 'CSA REGIONI AUTONOMIE LOCALI'];

            const [unions, setUnions] = useState([
                { id: '1', name: 'FP CGIL', voti: 30, deleghe: 25, adminH: "", adminM: "", forceRep: null },
                { id: '2', name: 'CISL FP', voti: 20, deleghe: 20, adminH: "", adminM: "", forceRep: null },
                { id: '3', name: 'UIL FPL', voti: 15, deleghe: 15, adminH: "", adminM: "", forceRep: null },
                { id: '4', name: 'CSA REGIONI AUTONOMIE LOCALI', voti: 10, deleghe: 10, adminH: "", adminM: "", forceRep: null }
            ]);

            const MIN_RSU_PRO_CAPITE = 30; 
            const MIN_OOSS_PRO_CAPITE = 30; 

            const formatTime = (totalMinutes) => {
                const total = Math.round(totalMinutes);
                const hours = Math.floor(total / 60);
                const minutes = total % 60;
                return `${hours}h ${minutes}m`;
            };

            const results = useMemo(() => {
                const totalVotiGlobali = unions.reduce((acc, u) => acc + (Number(u.voti) || 0), 0);
                const totalDelegheGlobali = unions.reduce((acc, u) => acc + (Number(u.deleghe) || 0), 0);
                const monteOreOOSSTotaleEnteMinuti = dipendenti * MIN_OOSS_PRO_CAPITE;

                // 1. Calcolo del peso per TUTTE le sigle inserite
                const baseUnions = unions.map(u => {
                    const pV = totalVotiGlobali > 0 ? ((Number(u.voti) || 0) / totalVotiGlobali) * 100 : 0;
                    const pD = totalDelegheGlobali > 0 ? ((Number(u.deleghe) || 0) / totalDelegheGlobali) * 100 : 0;
                    const pesoLocale = (pV + pD) / 2;
                    
                    const cleanName = u.name.trim().toUpperCase();
                    const isAutoRep = BIG_4_SIGLE.some(big => cleanName.includes(big.toUpperCase()));
                    const isRep = u.forceRep !== null ? u.forceRep : isAutoRep;

                    return { ...u, pesoLocale, isRep };
                });

                // Somma di TUTTI i pesi (dovrebbe essere circa 100%)
                const sumAllPesi = baseUnions.reduce((acc, u) => acc + u.pesoLocale, 0);

                return baseUnions.map(u => {
                    // Riparto proporzionale su TUTTI
                    const pesoNormalizzato = sumAllPesi > 0 ? (u.pesoLocale / sumAllPesi) * 100 : 0;
                    const monteOreLordoMinuti = (monteOreOOSSTotaleEnteMinuti * pesoNormalizzato) / 100;
                    
                    let monteOreNettoMinuti = 0;
                    let percCumulo = 0;

                    if (u.isRep) {
                        // Sigla Rappresentativa -> Applica decurtazione cumulo
                        percCumulo = dipendenti > 50 ? 38 : 57;
                        const quotaCumulataMinuti = monteOreLordoMinuti * (percCumulo / 100);
                        monteOreNettoMinuti = Math.round(monteOreLordoMinuti - quotaCumulataMinuti);
                    } else {
                        // Sigla non rappresentativa -> Mantiene tutto il lordo calcolato
                        monteOreNettoMinuti = Math.round(monteOreLordoMinuti);
                    }

                    // Verifica Esito Amministrazione
                    const h = parseInt(u.adminH);
                    const m = parseInt(u.adminM);
                    const hasData = !isNaN(h) || !isNaN(m);
                    const adminTotalMin = (h || 0) * 60 + (m || 0);
                    
                    let matchStatus = 'idle';
                    if (hasData && adminTotalMin > 0) {
                        matchStatus = adminTotalMin === monteOreNettoMinuti ? 'match' : 'mismatch';
                    }

                    return { ...u, pesoNormalizzato, monteOreNettoMinuti, percCumulo, matchStatus };
                });
            }, [unions, dipendenti]);

            const monteOreRSUMinuti = dipendenti * MIN_RSU_PRO_CAPITE;

            return (
                <div className="p-4 md:p-8 max-w-[1400px] mx-auto print:max-w-none">
                    {/* STAMPA HEADER */}
                    <div className="hidden print:block mb-10 border-b-2 border-black pb-6 text-center">
                        <h1 className="text-2xl font-bold uppercase underline">Verbale di Ripartizione Permessi Sindacali</h1>
                        <p className="mt-2 text-lg">Amministrazione: <strong>{enteNome || "...................."}</strong></p>
                    </div>

                    {/* WEB HEADER */}
                    <header className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-slate-200 pb-8 no-print">
                        <div className="flex items-center gap-6">
                            <img src="https://stage.fpcgil.lombardia.it/wp-content/uploads/2019/10/LOGO_LOMBARDIA.png" className="w-24 h-24 object-contain" alt="Logo" />
                            <div>
                                <h1 className="text-3xl font-black text-slate-900 tracking-tight">Software Prerogative Sindacali</h1>
                                <div className="mt-2 flex items-center bg-white border-2 border-dashed border-slate-300 rounded-xl px-4 py-2 hover:border-red-500 focus-within:border-red-600 transition-all">
                                    <input value={enteNome} onChange={(e) => setEnteNome(e.target.value)} className="bg-transparent border-none text-slate-800 text-lg font-bold focus:outline-none w-80" placeholder="Nome dell'Ente (es. Comune di Milano)..." />
                                </div>
                            </div>
                        </div>
                        <div className="bg-white p-5 rounded-3xl shadow-lg border-2 border-red-50">
                            <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1 text-center italic">Dipendenti (Teste)</label>
                            <div className="flex items-center gap-3">
                                <span className="text-red-600"><UserIcon /></span>
                                <input type="number" value={dipendenti} onChange={(e) => setDipendenti(Math.max(1, parseInt(e.target.value) || 0))} className="text-3xl font-black outline-none w-24 text-slate-800 bg-transparent text-center" />
                            </div>
                        </div>
                    </header>

                    {/* RIEPILOGO ORIZZONTALE */}
                    <section className="grid grid-cols-1 md:grid-cols-2 gap-6 no-print mb-8">
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-red-200 transition-colors">
                            <div className="flex items-center gap-4">
                                <div className="p-4 bg-red-50 rounded-2xl text-red-600"><ShieldIcon /></div>
                                <div>
                                    <h2 className="text-xs font-bold text-slate-400 uppercase mb-1">Monte Ore RSU Locale</h2>
                                    <p className="text-4xl font-black text-red-700">{formatTime(monteOreRSUMinuti)}</p>
                                </div>
                            </div>
                        </div>
                        <div className="bg-red-950 p-6 rounded-3xl shadow-xl flex items-center justify-between border border-red-900 group hover:border-red-500 transition-colors text-white">
                            <div className="flex items-center gap-4">
                                <div className="p-4 bg-red-900 rounded-2xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                                </div>
                                <div>
                                    <h2 className="text-xs font-bold text-red-400 uppercase mb-1">Lordo OO.SS. Ente</h2>
                                    <p className="text-4xl font-black">{formatTime(dipendenti * MIN_OOSS_PRO_CAPITE)}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <span className={`text-sm font-bold px-2 py-1 rounded-lg ${dipendenti > 50 ? 'bg-red-800' : 'bg-amber-800'}`}>
                                    {dipendenti > 50 ? 'Cumulo 38%' : 'Cumulo 57%'}
                                </span>
                            </div>
                        </div>
                    </section>

                    {/* TABELLA */}
                    <section className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-8 print:border-none print:shadow-none">
                        <div className="p-8 border-b border-slate-100 flex justify-between items-center no-print">
                            <h2 className="text-2xl font-black text-slate-900 tracking-tight">Dettaglio Calcolo e Verifica</h2>
                            <button onClick={() => setUnions([...unions, { id: Date.now().toString(), name: '', voti: 0, deleghe: 0, adminH: "", adminM: "", forceRep: null }])} className="flex items-center gap-2 px-6 py-3 bg-red-700 text-white rounded-2xl hover:bg-red-800 transition-all font-bold shadow-lg shadow-red-100">+ Aggiungi Sigla</button>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse print:min-w-full">
                                <thead className="bg-slate-50 border-b border-slate-100 print:bg-transparent print:border-black">
                                    <tr>
                                        <th className="py-5 px-8 text-xs font-bold text-slate-400 uppercase tracking-widest print:text-black">Sigla Sindacale</th>
                                        <th className="py-5 px-4 text-xs font-bold text-red-600 uppercase text-center print:text-black">Calcolo Amm.ne</th>
                                        <th className="py-5 px-4 text-xs font-bold text-slate-400 uppercase text-center print:text-black">Voti/Del.</th>
                                        <th className="py-5 px-4 text-xs font-bold text-slate-900 uppercase text-right print:text-black">Netto Software</th>
                                        <th className="py-5 px-8 text-xs font-bold text-slate-400 uppercase text-center no-print">Esito</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50 print:divide-black">
                                    {results.map((u) => (
                                        <tr key={u.id} className="group hover:bg-slate-50/50 transition-colors print:hover:bg-transparent">
                                            <td className="py-6 px-8">
                                                <div className="flex items-center gap-4">
                                                    <button onClick={() => setUnions(unions.map(un => un.id === u.id ? { ...un, forceRep: un.forceRep === null ? true : un.forceRep === true ? false : null } : un))} className={`no-print p-2 rounded-xl transition-all ${u.isRep ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-400'}`} title="Toggle Rappresentatività"><ShieldIcon /></button>
                                                    <div className="flex-1">
                                                        <input value={u.name} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, name: e.target.value } : un))} className="text-lg font-black text-slate-800 bg-transparent outline-none w-full print:border-none print:text-black" placeholder="Nome sigla..." />
                                                        <span className={`text-[10px] font-black block mt-1 uppercase ${u.isRep ? 'text-red-600' : 'text-slate-400'} print:text-black`}>
                                                            {u.isRep ? `Con detrazione cumulo (${u.percCumulo}%)` : 'Senza decurtazioni (Locale)'}
                                                        </span>
                                                    </div>
                                                    <button onClick={() => setUnions(unions.filter(un => un.id !== u.id))} className="no-print opacity-0 group-hover:opacity-100 p-2 hover:text-red-600 transition-opacity">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                    </button>
                                                </div>
                                            </td>
                                            <td className="py-6 px-4 text-center bg-red-50/20 print:bg-transparent">
                                                <div className="flex items-center justify-center gap-3">
                                                    <div className="flex flex-col items-center">
                                                        <span className="text-[9px] font-bold text-red-400 uppercase no-print">Ore</span>
                                                        <input type="number" value={u.adminH} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, adminH: e.target.value } : un))} className="w-14 text-center text-base border border-red-200 rounded-xl bg-white p-2 font-black text-red-700 outline-none print:border-none print:text-black" />
                                                    </div>
                                                    <span className="mt-4 font-black text-red-200 text-xl print:text-black">:</span>
                                                    <div className="flex flex-col items-center">
                                                        <span className="text-[9px] font-bold text-red-400 uppercase no-print">Min</span>
                                                        <input type="number" value={u.adminM} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, adminM: e.target.value } : un))} className="w-14 text-center text-base border border-red-200 rounded-xl bg-white p-2 font-black text-red-700 outline-none print:border-none print:text-black" />
                                                    </div>
                                                </div>
                                            </td>
                                            <td className="py-6 px-4">
                                                <div className="flex flex-col gap-3 items-center justify-center">
                                                    <div className="flex items-center gap-3"><label className="text-xs font-black text-slate-400 min-w-[40px] text-right print:text-black">VOTI</label><input type="number" value={u.voti} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, voti: e.target.value } : un))} className="w-20 text-center text-sm border border-slate-200 rounded-xl bg-white p-2 font-black text-slate-700 print:border-none" /></div>
                                                    <div className="flex items-center gap-3"><label className="text-xs font-black text-slate-400 min-w-[40px] text-right print:text-black">DEL.</label><input type="number" value={u.deleghe} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, deleghe: e.target.value } : un))} className="w-20 text-center text-sm border border-slate-200 rounded-xl bg-white p-2 font-black text-slate-700 print:border-none" /></div>
                                                </div>
                                            </td>
                                            <td className="py-6 px-4 text-right">
                                                <div className="inline-block bg-red-700 text-white px-6 py-3 rounded-2xl text-lg font-black print:bg-transparent print:text-black print:p-0 print:text-xl">
                                                    {formatTime(u.monteOreNettoMinuti)}
                                                </div>
                                            </td>
                                            <td className="py-6 px-8 text-center no-print">
                                                {u.matchStatus === 'match' ? (
                                                    <div className="flex flex-col items-center gap-1"><CheckIcon /><span className="text-[10px] font-bold text-emerald-600 uppercase mt-1">Conforme</span></div>
                                                ) : u.matchStatus === 'mismatch' ? (
                                                    <div className="flex flex-col items-center gap-1"><XIcon /><span className="text-[10px] font-bold text-red-600 uppercase mt-1">Differenza</span></div>
                                                ) : (
                                                    <div className="text-[11px] text-slate-300 italic px-4 py-2 bg-slate-50 rounded-lg">Inserire dati Amm.ne</div>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <footer className="bg-white p-8 rounded-3xl border-2 border-slate-100 flex flex-col md:flex-row items-center gap-8 shadow-sm no-print">
                        <div className="flex items-center gap-5 flex-1 text-red-700"><ShieldIcon />
                            <div>
                                <h4 className="text-lg font-black text-slate-900 tracking-tight leading-tight">Sistema Certificato FP CGIL - Funzioni Locali</h4>
                                <p className="text-sm text-slate-500 leading-relaxed max-w-2xl">Ripartizione proporzionale su tutte le sigle (Art. 28 CCNQ) con scorporo cumulo nazionale solo per le rappresentative.</p>
                            </div>
                        </div>
                        <button onClick={() => window.print()} className="w-full md:w-auto bg-red-700 text-white px-10 py-5 rounded-3xl flex items-center justify-center gap-4 hover:bg-red-800 transition-all shadow-2xl shadow-red-200 font-black uppercase text-sm tracking-widest active:scale-95 group">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="group-hover:scale-110 transition-transform"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                             Stampa Riepilogo
                        </button>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>