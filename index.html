<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Permessi Sindacali - FP CGIL Lombardia</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React e Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* LOGICA DI STAMPA */
        .print-view { display: none; }

        @media print {
            @page { size: landscape; margin: 10mm; }
            .no-print { display: none !important; }
            .print-view { display: block !important; width: 100%; color: black !important; }
            body { background: white !important; }
            
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .print-table th, .print-table td { border: 1px solid #333; padding: 10px; font-size: 12px; }
            .print-table th { background: #f0f0f0 !important; font-weight: bold; text-transform: uppercase; }
            .header-summary-print { border: 2px solid #b91c1c; padding: 15px; display: flex; justify-content: space-between; margin-bottom: 20px; border-radius: 8px; }
            
            .text-red-700 { color: #b91c1c !important; }
            .text-emerald-600 { color: #059669 !important; }
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo } = React;

        // Icone SVG interne
        const ShieldIcon = ({ className = "w-5 h-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        );
        const CheckIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className="text-emerald-600"><polyline points="20 6 9 17 4 12"></polyline></svg>
        );
        const XIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" className="text-red-600"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
        );

        const App = () => {
            // Esempio su ente di 80 dipendenti
            const [dipendenti, setDipendenti] = useState(80);
            const [enteNome, setEnteNome] = useState("");
            const [unions, setUnions] = useState([
                { id: '1', name: 'FP CGIL', voti: 30, deleghe: 25, adminH: "", adminM: "", forceRep: null },
                { id: '2', name: 'CISL FP', voti: 20, deleghe: 20, adminH: "", adminM: "", forceRep: null },
                { id: '3', name: 'UIL FPL', voti: 15, deleghe: 15, adminH: "", adminM: "", forceRep: null },
                { id: '4', name: 'CSA REGIONI AUTONOMIE LOCALI', voti: 10, deleghe: 10, adminH: "", adminM: "", forceRep: null },
                { id: '5', name: 'ALTRA SIGLA', voti: 5, deleghe: 5, adminH: "", adminM: "", forceRep: null }
            ]);

            const MIN_OOSS_PRO_CAPITE = 30;
            const MIN_RSU_PRO_CAPITE = 30;
            const BIG_4 = ['FP CGIL', 'CISL FP', 'UIL FPL', 'CSA REGIONI AUTONOMIE LOCALI'];

            const formatTime = (totalMinutes) => {
                const total = Math.round(totalMinutes);
                const h = Math.floor(total / 60);
                const m = total % 60;
                return `${h}h ${m}m`;
            };

            const results = useMemo(() => {
                const totalVoti = unions.reduce((acc, u) => acc + (Number(u.voti) || 0), 0);
                const totalDeleghe = unions.reduce((acc, u) => acc + (Number(u.deleghe) || 0), 0);
                const monteLordoTotaleMinuti = dipendenti * MIN_OOSS_PRO_CAPITE;

                const base = unions.map(u => {
                    const pV = totalVoti > 0 ? (Number(u.voti) / totalVoti) * 100 : 0;
                    const pD = totalDeleghe > 0 ? (Number(u.deleghe) / totalDeleghe) * 100 : 0;
                    const pesoLocale = (pV + pD) / 2;
                    const isRep = u.forceRep !== null ? u.forceRep : BIG_4.some(b => u.name.trim().toUpperCase().includes(b));
                    return { ...u, pesoLocale, isRep };
                });

                const sumAllPesi = base.reduce((acc, u) => acc + u.pesoLocale, 0);

                return base.map(u => {
                    let nettoU = 0;
                    const percRiduzione = dipendenti > 50 ? 38 : 57;

                    if (sumAllPesi > 0) {
                        const pesoRiproprozionato = (u.pesoLocale / sumAllPesi) * 100;
                        const quotaLordaU = (monteLordoTotaleMinuti * pesoRiproprozionato) / 100;
                        
                        if (u.isRep) {
                            nettoU = Math.round(quotaLordaU * (1 - percRiduzione / 100));
                        } else {
                            nettoU = Math.round(quotaLordaU);
                        }
                    }

                    const h = parseInt(u.adminH, 10);
                    const m = parseInt(u.adminM, 10);
                    const adminTot = (isNaN(h) ? 0 : h) * 60 + (isNaN(m) ? 0 : m);
                    
                    let match = 'idle';
                    if ((u.adminH !== "" || u.adminM !== "") && adminTot > 0) {
                        match = (adminTot === nettoU) ? 'match' : 'mismatch';
                    }

                    return { ...u, nettoU, match, currentReduction: percRiduzione };
                });
            }, [unions, dipendenti]);

            const monteRSU = dipendenti * MIN_RSU_PRO_CAPITE;
            const monteOOSS = dipendenti * MIN_OOSS_PRO_CAPITE;

            return (
                <div className="p-4 md:p-8 max-w-[1400px] mx-auto min-h-screen text-slate-900">
                    
                    {/* --- VERSIONE SEMPLIFICATA PER LA STAMPA --- */}
                    <div className="print-view">
                        <div className="text-center mb-6">
                            <h1 className="text-2xl font-black uppercase text-red-700">Calcolatore Permessi Sindacali - FP CGIL Lombardia</h1>
                            <p className="text-sm font-bold text-slate-500">Computo Certificato - Guida ARAN Maggio 2025</p>
                        </div>

                        <div className="header-summary-print">
                            <div style={{width: '40%'}}>
                                <p className="text-[10px] font-bold text-slate-400 uppercase">Ente Amministratore</p>
                                <p className="text-lg font-black">{enteNome || "NOME NON INSERITO"}</p>
                            </div>
                            <div style={{width: '30%', textAlign: 'center'}}>
                                <p className="text-[10px] font-bold text-slate-400 uppercase">Monte Ore RSU Locale</p>
                                <p className="text-lg font-black text-red-700">{formatTime(monteRSU)}</p>
                            </div>
                            <div style={{width: '30%', textAlign: 'right'}}>
                                <p className="text-[10px] font-bold text-slate-400 uppercase">Lordo OO.SS. Ente</p>
                                <p className="text-lg font-black">{formatTime(monteOOSS)}</p>
                            </div>
                        </div>

                        <table className="print-table">
                            <thead>
                                <tr>
                                    <th>Sigla Sindacale</th>
                                    <th style={{textAlign: 'center'}}>Calcolo Amm.ne</th>
                                    <th style={{textAlign: 'center'}}>Voti / Del.</th>
                                    <th style={{textAlign: 'right'}}>Calcolo corretto</th>
                                    <th style={{textAlign: 'center'}}>Esito</th>
                                </tr>
                            </thead>
                            <tbody>
                                {results.map(u => (
                                    <tr key={u.id}>
                                        <td className="font-bold">
                                            {u.name}
                                            <br/>
                                            <span style={{fontSize: '9px', fontWeight: 'normal'}}>
                                                {u.isRep ? `Detrazione Cumulo: ${u.currentReduction}%` : 'Altra Sigla (Quota Intera)'}
                                            </span>
                                        </td>
                                        <td style={{textAlign: 'center'}}>{u.adminH || 0}h {u.adminM || 0}m</td>
                                        <td style={{textAlign: 'center'}}>V: {u.voti} - D: {u.deleghe}</td>
                                        <td style={{textAlign: 'right'}} className="font-black text-red-700">{formatTime(u.nettoU)}</td>
                                        <td style={{textAlign: 'center', fontWeight: 'bold'}}>
                                            {u.match === 'match' ? "CONFORME" : u.match === 'mismatch' ? "DIFFERENZA" : "-"}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* --- INTERFACCIA WEB --- */}
                    <div className="no-print">
                        <header className="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-6 border-b border-slate-200 pb-8">
                            <div className="flex items-center gap-6">
                                <img src="https://stage.fpcgil.lombardia.it/wp-content/uploads/2019/10/LOGO_LOMBARDIA.png" className="w-24 h-24 object-contain" alt="Logo" />
                                <div>
                                    <h1 className="text-3xl font-black text-slate-900 tracking-tight leading-tight">Software Prerogative Sindacali</h1>
                                    <div className="mt-2 flex items-center bg-white border-2 border-dashed border-slate-300 rounded-xl px-4 py-2 hover:border-red-500 focus-within:border-red-600 transition-all shadow-sm">
                                        <input value={enteNome} onChange={(e) => setEnteNome(e.target.value)} className="bg-transparent border-none text-slate-800 text-lg font-bold focus:outline-none w-80 placeholder:text-slate-300" placeholder="Nome dell'Ente..." />
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-5 rounded-3xl shadow-lg border-2 border-red-50 flex flex-col items-center">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase mb-1 italic text-center">Dipendenti (Teste)</label>
                                <div className="flex items-center gap-2">
                                    <input type="number" value={dipendenti} onChange={(e) => setDipendenti(Math.max(1, parseInt(e.target.value) || 0))} className="text-3xl font-black outline-none w-24 text-slate-800 bg-transparent text-center" />
                                </div>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-red-50 rounded-2xl text-red-600"><ShieldIcon /></div>
                                    <div><h2 className="text-xs font-bold text-slate-400 uppercase mb-1">Monte Ore RSU Locale</h2><p className="text-4xl font-black text-red-700">{formatTime(monteRSU)}</p></div>
                                </div>
                            </div>
                            <div className="bg-red-950 p-6 rounded-3xl shadow-xl flex items-center justify-between border border-red-900 text-white">
                                <div className="flex items-center gap-4">
                                    <div className="p-4 bg-red-900 rounded-2xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                                    </div>
                                    <div><h2 className="text-xs font-bold text-red-400 uppercase mb-1 text-red-300">Lordo OO.SS. Ente</h2><p className="text-4xl font-black">{formatTime(monteOOSS)}</p></div>
                                </div>
                                <div className="text-right">
                                    <span className="text-[10px] font-bold text-red-400 uppercase block mb-1">Riferimento</span>
                                    <span className="text-sm font-bold bg-red-800 px-3 py-1 rounded-full text-red-100">
                                        CCNQ 4.12.2017
                                    </span>
                                </div>
                            </div>
                        </div>

                        <section className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                            <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-white">
                                <h2 className="text-2xl font-black text-slate-900 tracking-tight">Prospetto di Confronto Sigle</h2>
                                <button onClick={() => setUnions([...unions, { id: Date.now().toString(), name: '', voti: 0, deleghe: 0, adminH: "", adminM: "", forceRep: null }])} className="flex items-center gap-2 px-6 py-3 bg-red-700 text-white rounded-2xl hover:bg-red-800 transition-all font-bold shadow-lg shadow-red-100"><ShieldIcon className="w-4 h-4" /> Aggiungi Sigla</button>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th className="py-5 px-8 text-xs font-bold text-slate-400 uppercase tracking-widest">Sigla Sindacale</th>
                                            <th className="py-5 px-4 text-xs font-bold text-red-600 uppercase text-center">Calcolo Amm.ne</th>
                                            <th className="py-5 px-4 text-xs font-bold text-slate-400 uppercase text-center">Voti/Del.</th>
                                            <th className="py-5 px-4 text-xs font-bold text-slate-900 uppercase text-right">Calcolo corretto</th>
                                            <th className="py-5 px-8 text-xs font-bold text-slate-400 uppercase text-center">Esito</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {results.map((u) => (
                                            <tr key={u.id} className="group hover:bg-slate-50/50 transition-colors">
                                                <td className="py-6 px-8">
                                                    <div className="flex items-center gap-4">
                                                        <button onClick={() => setUnions(unions.map(un => un.id === u.id ? { ...un, forceRep: un.forceRep === null ? true : un.forceRep === true ? false : null } : un))} className={`p-2 rounded-xl transition-all ${u.isRep ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-400'}`}><ShieldIcon /></button>
                                                        <div className="flex-1">
                                                            <input value={u.name} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, name: e.target.value } : un))} className="text-lg font-black text-slate-800 bg-transparent outline-none w-full border-b border-transparent focus:border-red-500" placeholder="Nome sigla..." />
                                                            <span className={`text-[10px] font-black block mt-1 uppercase ${u.isRep ? 'text-red-600' : 'text-slate-400'}`}>
                                                                {u.isRep ? `Detrazione Cumulo: ${u.currentReduction}%` : 'Altra Sigla (Quota Intera)'}
                                                            </span>
                                                        </div>
                                                        <button onClick={() => setUnions(unions.filter(un => un.id !== u.id))} className="opacity-0 group-hover:opacity-100 p-2 hover:text-red-600 transition-opacity">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                        </button>
                                                    </div>
                                                </td>
                                                <td className="py-6 px-4 text-center bg-red-50/20">
                                                    <div className="flex items-center justify-center gap-3">
                                                        <div className="flex flex-col items-center">
                                                            <span className="text-[9px] font-bold text-red-400 uppercase">Ore</span>
                                                            <input type="number" value={u.adminH} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, adminH: e.target.value } : un))} className="w-14 text-center text-base border border-red-200 rounded-xl bg-white p-2 font-black text-red-700 outline-none focus:ring-2 focus:ring-red-300" />
                                                        </div>
                                                        <span className="mt-4 font-black text-red-200 text-xl">:</span>
                                                        <div className="flex flex-col items-center">
                                                            <span className="text-[9px] font-bold text-red-400 uppercase">Min</span>
                                                            <input type="number" value={u.adminM} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, adminM: e.target.value } : un))} className="w-14 text-center text-base border border-red-200 rounded-xl bg-white p-2 font-black text-red-700 outline-none focus:ring-2 focus:ring-red-300" />
                                                        </div>
                                                    </div>
                                                </td>
                                                <td className="py-6 px-4">
                                                    <div className="flex flex-col gap-2 items-center justify-center">
                                                        <div className="flex items-gap-2"><label className="text-xs font-black text-slate-400 min-w-[35px] text-right">VOTI</label><input type="number" value={u.voti} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, voti: e.target.value } : un))} className="w-16 text-center text-sm border border-slate-200 rounded-xl bg-white p-2 font-black text-slate-700" /></div>
                                                        <div className="flex items-gap-2"><label className="text-xs font-black text-slate-400 min-w-[35px] text-right">DEL.</label><input type="number" value={u.deleghe} onChange={(e) => setUnions(unions.map(un => un.id === u.id ? { ...un, deleghe: e.target.value } : un))} className="w-16 text-center text-sm border border-slate-200 rounded-xl bg-white p-2 font-black text-slate-700" /></div>
                                                    </div>
                                                </td>
                                                <td className="py-6 px-4 text-right">
                                                    <div className="inline-block bg-red-700 text-white px-6 py-3 rounded-2xl text-lg font-black">{formatTime(u.nettoU)}</div>
                                                </td>
                                                <td className="py-6 px-8 text-center">
                                                    {u.match === 'match' ? (
                                                        <div className="flex flex-col items-center gap-1"><CheckIcon /><span className="text-[10px] font-bold text-emerald-600 uppercase mt-1">Conforme</span></div>
                                                    ) : u.match === 'mismatch' ? (
                                                        <div className="flex flex-col items-center gap-1"><XIcon /><span className="text-[10px] font-bold text-red-600 uppercase mt-1">Differenza</span></div>
                                                    ) : (
                                                        <div className="text-[11px] text-slate-300 italic px-4 py-2 bg-slate-50 rounded-lg text-center">Inserire dati Amm.ne</div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <footer className="bg-white p-8 rounded-3xl border-2 border-slate-100 flex flex-col md:flex-row items-center gap-8 shadow-sm">
                            <div className="flex items-center gap-5 flex-1 text-red-700"><ShieldIcon className="w-10 h-10" />
                                <div>
                                    <h4 className="text-lg font-black text-slate-900 tracking-tight leading-tight uppercase">Sistema di Stampa Certificata FP CGIL</h4>
                                    <p className="text-sm text-slate-500 leading-relaxed max-w-2xl">Il calcolo riproporziona i pesi su tutte le sigle presenti e applica la detrazione individuale del cumulo solo alle sigle rappresentative.</p>
                                </div>
                            </div>
                            <button onClick={() => window.print()} className="w-full md:w-auto bg-red-700 text-white px-10 py-5 rounded-3xl flex items-center justify-center gap-4 hover:bg-red-800 transition-all shadow-2xl shadow-red-200 font-black uppercase text-sm tracking-widest active:scale-95 group">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="group-hover:scale-110 transition-transform"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                 Stampa Riepilogo
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>